# Form16 Extractor

A comprehensive Python library for extracting structured data from Indian Form16 tax documents with advanced multi-company consolidation and tax calculation capabilities.

## Overview

Form16 Extractor transforms PDF Form16 documents into structured JSON data and provides comprehensive tax calculation services. Designed to handle real-world complexities including multi-employer scenarios, varying PDF formats, and accurate tax computations across different tax regimes.

This library addresses practical challenges faced by tax professionals, HR departments, and individuals managing multiple Form16 documents from different employers within the same financial year.

## Key Features

- **Multi-Company Consolidation**: Seamlessly consolidate Form16 documents from multiple employers within the same financial year
- **Comprehensive Tax Calculations**: Accurate tax computation with support for both old and new tax regimes
- **Financial Year Validation**: Ensures consolidation integrity by validating matching financial years
- **High Accuracy Extraction**: Domain-driven extraction engine with 85-90% field coverage on real Form16 documents  
- **Format Flexibility**: Handles variations in layouts across different employers and tax software
- **Privacy Focused**: Local processing only - no data transmission or external dependencies
- **Production Ready**: Comprehensive error handling, logging, validation, and CLI interface
- **Developer Experience**: Full type hints, detailed documentation, and intuitive API

## Form16 Background

Form16 is the official tax certificate issued by employers to employees in India, containing:

- **Part A**: TDS certificate with quarterly tax deduction summary
- **Part B**: Detailed salary computation including basic pay, allowances, exemptions, and deductions under various sections (80C, 80D, etc.)

The challenge with Form16 processing lies in the inconsistent PDF layouts generated by different payroll systems, making reliable data extraction complex.

## Installation

```bash
pip install -r requirements.txt
```

## Quick Start

```python
from form16_extractor.extractors.enhanced_form16_extractor import EnhancedForm16Extractor

# Initialize the extractor
extractor = EnhancedForm16Extractor()

# Extract data from Form16 PDF
result = extractor.extract_from_file("form16.pdf")

# Access structured data
if result.status == "success":
    form16_data = result.data
    
    print(f"Employee: {form16_data.employee_info.employee_name}")
    print(f"Gross Salary: ₹{form16_data.salary_breakdown.gross_salary:,.2f}")
    print(f"PAN: {form16_data.employee_info.employee_pan}")
    
    # Access detailed breakdowns
    deductions = form16_data.deductions
    tds_details = form16_data.quarterly_tds
```

### Command Line Usage

```bash
# Extract single Form16 with tax calculation
python cli.py extract --file form16.pdf --calculate-tax --output result.json

# Extract with detailed tax breakdown
python cli.py extract --file form16.pdf --calculate-tax --summary

# Consolidate multiple Form16s from same financial year
python cli.py consolidate --files form16_company1.pdf form16_company2.pdf --calculate-tax

# Compare tax regimes
python cli.py extract --file form16.pdf --calculate-tax --tax-regime both

# Validate extraction results
python cli.py validate --file result.json
```

### Multi-Company Consolidation

For employees working at multiple companies in the same financial year:

```python
from form16_extractor.consolidators.multi_company_consolidator import MultiCompanyForm16Consolidator

consolidator = MultiCompanyForm16Consolidator()

# Extract individual Form16s
form16_list = [
    extractor.extract_from_file("company1_form16.pdf").data,
    extractor.extract_from_file("company2_form16.pdf").data
]

# Consolidate with validation
consolidated_result = consolidator.consolidate_form16s(form16_list)

if consolidated_result.status == "success":
    consolidated_form16 = consolidated_result.data
    print(f"Total Gross Salary: ₹{consolidated_form16.salary_breakdown.gross_salary:,.2f}")
    print(f"Combined TDS: ₹{consolidated_form16.quarterly_tds.total_tds:,.2f}")
```

### Tax Calculation

```python
from form16_extractor.tax_calculators.main_calculator import MainTaxCalculator

# Initialize tax calculator
tax_calculator = MainTaxCalculator(financial_year="2023-24")

# Calculate tax for both regimes
tax_results = tax_calculator.calculate_comprehensive_tax(
    form16_data=form16_data,
    city_type="metro",
    age_category="below_60"
)

# Compare regimes
old_regime = tax_results["old_regime"]
new_regime = tax_results["new_regime"]

print(f"Old Regime Tax: ₹{old_regime.tax_liability:,.2f}")
print(f"New Regime Tax: ₹{new_regime.tax_liability:,.2f}")
print(f"Recommended: {tax_results['recommended_regime']}")
```


## Data Structure

The extractor returns structured data with the following key components:

### Employee Information
- Name, PAN, designation, address
- Employee ID and other identifiers

### Employer Details  
- Company name, TAN, PAN
- Address and registration details

### Salary Breakdown
- Basic salary, HRA, allowances
- Gross salary and total income
- Section 17 perquisites details

### Tax Deductions
- Section 80C (PPF, insurance premiums)
- Section 80D (medical insurance)
- Other Chapter VI-A deductions

### Quarterly TDS
- Quarter-wise tax deduction summary
- Deposit dates and receipt numbers
- BSR codes and challan details

### Tax Computation
- Comprehensive tax calculations for both old and new tax regimes
- Accurate surcharge calculations with marginal relief
- HRA, LTA, and other exemption calculations
- Professional tax and Section 89 relief computations
- Final tax liability vs TDS with refund/payable amounts

## Output JSON Structure

The extractor returns comprehensive structured data in JSON format:

<details>
<summary><strong>View Complete JSON Structure</strong></summary>

```json
{
  "status": "success",
  "metadata": {
    "file_name": "form16_sample.pdf",
    "processing_time_seconds": 7.86,
    "extraction_timestamp": "2024-09-09 14:30:54",
    "extractor_version": "1.0.0"
  },
  "form16": {
    "part_a": {
      "header": {
        "form_number": "FORM NO. 16",
        "rule_reference": "[See rule 31(1)(a)]",
        "certificate_description": "Certificate under Section 203 of the Income-tax Act, 1961",
        "certificate_number": "CERT789123",
        "last_updated": "2024-05-15"
      },
      "employer": {
        "name": "TECH SOLUTIONS INDIA PRIVATE LIMITED",
        "address": "IT Park, Tower A, 3rd Floor, Business District, Example City - 100001, , +91-99-12345678",
        "tan": "TEST12345E",
        "pan": "TEST12345F"
      },
      "employee": {
        "name": "Test User",
        "pan": "TEST56789P",
        "address": "123 Main Street, Andheri East, Example City - 100001, ",
        "employee_reference_number": "EMP001234"
      },
      "quarterly_tds_summary": {
        "quarter_1": {
          "period": "Q1",
          "receipt_numbers": ["Q1234567"],
          "amount_paid_credited": 437500.0,
          "amount_deducted": 43750.0,
          "amount_deposited": 43750.0,
          "deposited_date": "2023-07-15",
          "status": "Deposited"
        },
        "total_tds": {
          "amount_paid_credited": 1750000.0,
          "deducted": 175000.0,
          "deposited": 175000.0
        }
      }
    },
    "part_b": {
      "gross_salary": {
        "section_17_1_salary": 1500000.0,
        "section_17_2_perquisites": 95000.0,
        "section_17_3_profits_in_lieu": 0.0,
        "total": 1595000.0
      },
      "allowances_exempt_under_section_10": {
        "house_rent_allowance": 180000.0,
        "leave_travel_allowance": 32000.0,
        "total_exemption": 248000.0
      },
      "deductions_under_section_16": {
        "standard_deduction": 50000.0,
        "professional_tax": 2500.0,
        "total": 52500.0
      },
      "chapter_vi_a_deductions": {
        "section_80c": {
          "ppf_contribution": 150000.0,
          "tuition_fees": 32000.0,
          "total": 150000.0
        },
        "section_80ccd_1b": 50000.0,
        "section_80d": {
          "self_family": 25000.0,
          "parents": 30000.0,
          "total": 55000.0
        },
        "section_80g": 10000.0,
        "total_chapter_via_deductions": 265000.0
      },
      "tax_computation": {
        "income_chargeable_under_head_salary": 1294500.0,
        "tax_on_total_income": 154725.0,
        "health_and_education_cess": 6189.0,
        "total_tax_liability": 160914.0,
        "tax_payable": 160914.0,
        "less_tds": 175000.0,
        "tax_due_refund": -14086.0
      }
    }
  },
  "extraction_metrics": {
    "confidence_scores": {
      "employee": {"name": 0.95, "pan": 0.95, "address": 0.85},
      "employer": {"name": 0.92, "tan": 0.95, "address": 0.88},
      "salary": {"gross_salary": 0.94, "allowances": 0.87},
      "deductions": {"section_80c": 0.89, "section_80d": 0.86},
      "tax": {"tax_computation": 0.92, "tds_summary": 0.88}
    },
    "extraction_summary": {
      "total_possible_fields": 250,
      "extracted_fields": 134,
      "extraction_rate": 53.6,
      "quality_score": 78.5
    }
  }
}
```

</details>

### Key Data Components

- **Part A**: TDS certificate with employer/employee details and quarterly tax summary
- **Part B**: Detailed salary computation with exemptions, deductions, and tax calculation  
- **Extraction Metrics**: Confidence scores and coverage statistics
- **Metadata**: Processing information and timestamps

The structure supports 250+ possible fields across all major Form16 sections including comprehensive Chapter VI-A deductions (80C, 80D, 80CCD, etc.).

See `ENHANCED_JSON_STRUCTURE.md` for complete field specifications.

## Use Cases

- **Payroll Systems**: Automate Form16 data import for salary processing
- **Tax Software**: Process employee tax certificates  
- **HR Analytics**: Extract compensation data for analysis
- **Compliance Tools**: Verify tax computations and TDS deposits
- **Financial Services**: Process loan applications requiring income verification

## Testing

```bash
# Run all tests
python -m pytest tests/

# Run with coverage
python -m pytest --cov=form16_extractor tests/

# Run specific test suites
python -m pytest tests/unit/models/
python -m pytest tests/unit/extractors/domains/
```

## Architecture

The library uses a domain-driven design approach with comprehensive tax calculation and consolidation capabilities:

```
form16_extractor/
├── extractors/
│   ├── domains/              # Domain-specific extractors
│   │   ├── identity/         # Employee/employer extraction
│   │   ├── salary/           # Salary and perquisite extraction
│   │   ├── deductions/       # Tax deduction extraction
│   │   └── metadata/         # Document metadata and TDS
│   ├── enhanced_form16_extractor.py  # Main orchestrator
│   └── base/                 # Base interfaces
├── tax_calculators/          # Comprehensive tax calculation system
│   ├── engines/              # Tax regime engines (old/new)
│   ├── components/           # HRA, LTA, gratuity calculators
│   ├── rules/                # Year-specific tax rules
│   └── interfaces/           # Calculator interfaces
├── consolidators/            # Multi-company Form16 consolidation
│   ├── multi_company_consolidator.py
│   └── interfaces/           # Consolidation interfaces
├── integrators/              # Form16 and tax calculation integration
├── models/                   # Pydantic data models
├── pdf/                      # PDF processing and table classification
├── exceptions/               # Custom exception handling
├── utils/                    # Helper utilities and validation
└── cli.py                    # Command-line interface
```

## Requirements

- Python 3.8+
- Dependencies listed in `requirements.txt`

Key dependencies:
- `pydantic` - Data validation and models
- `pandas` - Data processing
- `camelot-py` - PDF table extraction
- `pdfplumber` - PDF text extraction

## Error Handling

The library provides comprehensive error handling:

```python
try:
    result = extractor.extract_from_file("form16.pdf")
    
    if result.status == "success":
        # Process successful extraction
        form16_data = result.data
    elif result.status == "partial":
        # Some data extracted with warnings
        print("Extraction completed with warnings:")
        for warning in result.warnings:
            print(f"- {warning}")
    else:
        # Handle extraction failure
        print(f"Extraction failed: {result.error}")
        
except Exception as e:
    print(f"Processing error: {e}")
```

## Privacy & Security

- **Local Processing**: All operations run locally - no external API calls
- **Data Privacy**: No data retention, logging, or transmission
- **Memory Management**: Secure cleanup of sensitive data from memory
- **Input Validation**: Safe PDF parsing with malformed document handling

## Contributing

Contributions are welcome! Please follow these guidelines:

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality  
4. Ensure all tests pass
5. Submit a pull request

## Tax Calculation Features

### Supported Tax Components

The tax calculator includes comprehensive support for:

**Income Tax Slabs**
- Both old and new tax regime calculations for AY 2024-25
- Automatic slab-wise tax computation
- Marginal rate calculations

**Surcharge and Cess**
- Accurate surcharge calculation (10% for income > 50L, 15% for > 1Cr)
- Marginal relief for surcharge threshold crossings
- 4% Health and Education Cess on total tax

**Exemptions and Deductions**
- HRA exemption with metro/non-metro differentiation
- LTA exemption with block year validation
- Section 80C investments (PPF, ELSS, insurance)
- Section 80D medical insurance premiums
- Professional tax deductions (state-wise)
- Section 89 relief for salary arrears

**Perquisite Calculations**
- Accommodation perquisite valuation
- Motor car perquisite (owned vs leased)
- ESOP perquisite calculations
- Medical reimbursement limits

**Gratuity Calculations**
- Statutory gratuity exemption (up to 20L)
- Service period and salary-based calculations

### Financial Year Support

The system is designed for multi-year support with currently implemented rules for:
- Assessment Year 2024-25 (Financial Year 2023-24)
- Extensible architecture for future years

### Regime Comparison

Automatically compares both tax regimes and provides recommendations based on:
- Net tax liability comparison
- Available deduction optimization
- Effective tax rate analysis

## Multi-Company Scenarios

### Common Use Cases

- **Job Changes**: Employees switching companies mid-year
- **Consultant Work**: Working for multiple employers simultaneously  
- **Part-time Engagements**: Additional income from secondary employers
- **Freelance Income**: Multiple client relationships with TDS

### Validation Features

- **Financial Year Matching**: Ensures all Form16s belong to the same assessment year
- **Employee Consistency**: Validates PAN and employee details across documents
- **Duplicate Detection**: Identifies and warns about potential duplicate entries
- **TDS Verification**: Cross-validates TDS amounts and dates

### Development Setup

```bash
# Clone and install
git clone <repository-url>
cd form16_extractor
pip install -r requirements.txt

# Run tests
python -m pytest tests/

# Run with coverage
python -m pytest --cov=form16_extractor tests/
```

## License

This project is licensed under the MIT License.

## Legal Notice

This library is intended for legitimate business use cases involving tax document processing. Users are responsible for ensuring compliance with applicable data protection and privacy laws.